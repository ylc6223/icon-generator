# å³é”®èœå•æŠ€æœ¯è§„èŒƒ

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [åŠŸèƒ½éœ€æ±‚](#åŠŸèƒ½éœ€æ±‚)
- [UI/UX è®¾è®¡](#uiux-è®¾è®¡)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)
- [æµ‹è¯•è¦ç‚¹](#æµ‹è¯•è¦ç‚¹)

---

## æ¦‚è¿°

ä¸ºç”»å¸ƒåŒºåŸŸçš„å›¾æ ‡è¾¹ç•Œæ¡†æ·»åŠ è‡ªå®šä¹‰å³é”®èœå•åŠŸèƒ½ï¼Œç»Ÿä¸€å›¾æ ‡æ“ä½œå…¥å£ï¼Œæå‡åº”ç”¨çš„ä¸“ä¸šæ€§å’Œæ˜“ç”¨æ€§ã€‚

### è®¾è®¡ç›®æ ‡

1. **ç»Ÿä¸€äº¤äº’å…¥å£**ï¼šå°†å›¾æ ‡ç¼–è¾‘æ“ä½œé›†ä¸­åœ¨å³é”®èœå•ä¸­
2. **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›ç¬¦åˆç”¨æˆ·ä¹ æƒ¯çš„ä¸Šä¸‹æ–‡èœå•äº¤äº’
3. **ä¿æŒå¯æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥æ·»åŠ æ›´å¤šèœå•é¡¹é¢„ç•™ç©ºé—´
4. **é›†æˆç°æœ‰ç³»ç»Ÿ**ï¼šä¸æ’¤é”€/é‡åšç³»ç»Ÿæ— ç¼é›†æˆ

---

## åŠŸèƒ½éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. èœå•è§¦å‘

- **è§¦å‘æ¡ä»¶**ï¼šåªåœ¨è¾¹ç•Œæ¡†ï¼ˆå›¾æ ‡åŒºåŸŸï¼‰ä¸Šå³é”®æ—¶è§¦å‘
- **è§¦å‘è¡Œä¸º**ï¼š
  - è‡ªåŠ¨é€‰ä¸­å³é”®ç‚¹å‡»çš„å›¾æ ‡
  - å…³é—­ä¹‹å‰æ‰“å¼€çš„èœå•ï¼ˆå…¨å±€å”¯ä¸€èœå•ï¼‰
  - åœ¨é¼ æ ‡æŒ‡é’ˆä½ç½®æ˜¾ç¤ºèœå•

#### 2. èœå•å…³é—­

èœå•åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å…³é—­ï¼š
- ç‚¹å‡»èœå•å¤–éƒ¨åŒºåŸŸ
- ç‚¹å‡»ä»»ä½•èœå•é¡¹
- æŒ‰ä¸‹ `ESC` é”®

#### 3. åˆå§‹èœå•é¡¹

| æ“ä½œ | å›¾æ ‡ | å¿«æ·é”® | æè¿° |
|------|------|--------|------|
| **é‡å‘½å** | `Edit` | `F2` / `Ctrl+R` | ç¼–è¾‘å›¾æ ‡æ ‡ç­¾ |
| **åˆ é™¤** | `Trash2` | `Delete` | ç§»é™¤å›¾æ ‡è¾¹ç•Œæ¡†ï¼ˆæ”¯æŒæ’¤é”€ï¼‰ |

**å¿«æ·é”®è¯´æ˜**ï¼š
- `F2`: ä¼ ç»Ÿé‡å‘½åå¿«æ·é”®ï¼ˆWindows/Linuxï¼‰
- `Ctrl+R`: è·¨å¹³å°ä¸€è‡´çš„é‡å‘½åå¿«æ·é”®
- `Delete`: åˆ é™¤å½“å‰é€‰ä¸­å›¾æ ‡

### äº¤äº’è¡Œä¸º

#### é€‰ä¸­çŠ¶æ€ç®¡ç†

- å³é”®ç‚¹å‡»æœªé€‰ä¸­çš„å›¾æ ‡ â†’ è‡ªåŠ¨é€‰ä¸­è¯¥å›¾æ ‡å¹¶æ˜¾ç¤ºèœå•
- å³é”®ç‚¹å‡»å·²é€‰ä¸­çš„å›¾æ ‡ â†’ ç›´æ¥æ˜¾ç¤ºèœå•

#### æ“ä½œæµç¨‹

**é‡å‘½åæµç¨‹**ï¼š
1. ç”¨æˆ·å³é”®ç‚¹å‡»å›¾æ ‡ â†’ é€‰æ‹©"é‡å‘½å"ï¼ˆæˆ–æŒ‰ F2 / Ctrl+Rï¼‰
2. èœå•å…³é—­ï¼Œç„¦ç‚¹è¿”å›åˆ°è¾¹ç•Œæ¡†
3. åœ¨è¾¹ç•Œæ¡†ä¸Šæ–¹æ˜¾ç¤ºè¾“å…¥æ¡†å¹¶è‡ªåŠ¨èšç„¦
4. ç”¨æˆ·è¾“å…¥æ–°åç§°ï¼š
   - æŒ‰Enteræˆ–ç‚¹å‡»"ä¿å­˜" â†’ ä¿å­˜æ ‡ç­¾ï¼Œå…³é—­è¾“å…¥æ¡†
   - æŒ‰ESCæˆ–ç‚¹å‡»"å–æ¶ˆ" â†’ æ”¾å¼ƒä¿®æ”¹ï¼Œå…³é—­è¾“å…¥æ¡†
   - æ¸…ç©ºæ–‡æœ¬å¹¶ä¿å­˜ â†’ åˆ é™¤æ ‡ç­¾ï¼Œæ¢å¤æ˜¾ç¤ºé»˜è®¤ID
5. æ“ä½œä¿å­˜åˆ°æ’¤é”€å†å²
6. è¾“å…¥æ¡†æ‰“å¼€æœŸé—´ï¼Œå…¨å±€å¿«æ·é”®ï¼ˆDeleteã€F2ã€Ctrl+Rï¼‰è¢«ç¦ç”¨

**åˆ é™¤æµç¨‹**ï¼š
1. ç”¨æˆ·å³é”®ç‚¹å‡»å›¾æ ‡ â†’ é€‰æ‹©"åˆ é™¤"ï¼ˆæˆ–æŒ‰ Delete é”®ï¼‰
2. èœå•å…³é—­ï¼Œå›¾æ ‡è¾¹ç•Œæ¡†ç«‹å³ç§»é™¤
3. æ“ä½œä¿å­˜åˆ°æ’¤é”€å†å²
4. ç”¨æˆ·å¯æŒ‰ Ctrl+Z æ’¤é”€åˆ é™¤æ“ä½œ

---

## UI/UX è®¾è®¡

### è§†è§‰è®¾è®¡

#### èœå•æ ·å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ é‡å‘½å    Ctrl+R    â”‚ â† å›¾æ ‡ + æ–‡å­— + å¿«æ·é”®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† åˆ†éš”ç¬¦
â”‚ ğŸ—‘ï¸ åˆ é™¤       Del     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- æ¯ä¸ªèœå•é¡¹å·¦ä¾§æ˜¾ç¤ºæ“ä½œå›¾æ ‡ï¼ˆæ¥è‡ª `lucide-react`ï¼‰
- èœå•é¡¹å³ä¾§æ˜¾ç¤ºå¿«æ·é”®æç¤ºï¼ˆç°è‰²å°å­—ï¼‰
- åˆ†ç»„ä¹‹é—´ä½¿ç”¨åˆ†éš”ç¬¦ï¼ˆ`ContextMenuSeparator`ï¼‰
- æ‚¬åœé«˜äº®å½“å‰èœå•é¡¹
- æ ‡å‡†å‹è§†è§‰å¯†åº¦ï¼ˆèˆ’é€‚çš„ paddingï¼‰

#### åŠ¨ç”»æ•ˆæœ

- **æ‰“å¼€åŠ¨ç”»**ï¼šæ·¡å…¥ï¼ˆfade-inï¼‰ï¼Œ150ms
- **å…³é—­åŠ¨ç”»**ï¼šæ·¡å‡ºï¼ˆfade-outï¼‰ï¼Œ100ms
- ä½¿ç”¨ framer-motion æˆ– CSS transitions

#### å®šä½è§„åˆ™

- èœå•ä½ç½®ï¼šé¼ æ ‡æŒ‡é’ˆä½ç½®
- æ™ºèƒ½è¾¹ç•Œæ£€æµ‹ï¼ˆå¦‚æœè¶…å‡ºå±å¹•å³ä¾§ï¼Œèœå•å‘å·¦åç§»ï¼‰
- æœ€å°é—´è·ï¼šè·ç¦»å±å¹•è¾¹ç¼˜ 8px

### é”®ç›˜å¯¼èˆª

æ”¯æŒå®Œæ•´çš„é”®ç›˜å¯¼èˆªï¼š

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| `â†‘` / `â†“` | åœ¨èœå•é¡¹ä¹‹é—´å¯¼èˆª |
| `Enter` | æ‰§è¡Œå½“å‰é€‰ä¸­çš„èœå•é¡¹ |
| `ESC` | å…³é—­èœå•ï¼Œç„¦ç‚¹è¿”å›åˆ°è¾¹ç•Œæ¡† |
| `F2` | å¿«é€Ÿé‡å‘½åå½“å‰é€‰ä¸­å›¾æ ‡ |
| `Ctrl+R` | å¿«é€Ÿé‡å‘½åå½“å‰é€‰ä¸­å›¾æ ‡ï¼ˆè·¨å¹³å°ï¼‰ |
| `Delete` | å¿«é€Ÿåˆ é™¤å½“å‰é€‰ä¸­å›¾æ ‡ |

**å¿«æ·é”®ç¦ç”¨è§„åˆ™**ï¼š
- è¾“å…¥æ¡†æ‰“å¼€æ—¶ï¼Œå…¨å±€å¿«æ·é”®ï¼ˆDeleteã€F2ã€Ctrl+Rï¼‰è¢«ç¦ç”¨
- èœå•æ‰“å¼€æ—¶ï¼Œå¿«æ·é”®ä»ç„¶æœ‰æ•ˆï¼ˆå¯å¿«é€Ÿæ“ä½œï¼‰

### å¯è®¿é—®æ€§

- å®Œæ•´çš„é”®ç›˜å¯¼èˆªæ”¯æŒ
- ARIA æ ‡ç­¾å’Œè§’è‰²å±æ€§ï¼ˆContextMenu å†…ç½®æ”¯æŒï¼‰
- ç„¦ç‚¹ç®¡ç†ï¼š
  - èœå•æ‰“å¼€æ—¶ç„¦ç‚¹è¿›å…¥èœå•
  - èœå•å…³é—­åç„¦ç‚¹è¿”å›åˆ°è¾¹ç•Œæ¡†
  - è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦ï¼ˆé€‰æ‹©"é‡å‘½å"åï¼‰

---

## æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆé€‰æ‹©

#### ä½¿ç”¨ ContextMenu ç»„ä»¶

**é€‰æ‹©ç†ç”±**ï¼š
- Radix UI ä¸“é—¨ä¸ºå³é”®èœå•è®¾è®¡çš„ `ContextMenu` ç»„ä»¶
- æ›´ç¬¦åˆå³é”®èœå•çš„äº¤äº’æ¨¡å¼
- å†…ç½®é˜²æ­¢é»˜è®¤å³é”®èœå•åŠŸèƒ½
- æ”¯æŒé”®ç›˜å¯¼èˆªå’Œå¯è®¿é—®æ€§

**æ ¸å¿ƒç»„ä»¶**ï¼š
```tsx
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuTrigger,
} from '@/components/ui/context-menu';
```

> **æ³¨æ„**ï¼šå¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰ `ContextMenu` ç»„ä»¶ï¼Œéœ€è¦ä» shadcn/ui æ·»åŠ ï¼š
> ```bash
> npx shadcn@latest add context-menu
> ```

### ç»„ä»¶ç»“æ„

```
BoundingBoxEditor (ç°æœ‰ç»„ä»¶)
  â””â”€â”€ ContextMenu (æ–°å¢ç»„ä»¶)
        â”œâ”€â”€ ContextMenu
        â”‚     â”œâ”€â”€ ContextMenuTrigger (è¾¹ç•Œæ¡†æœ¬èº«)
        â”‚     â””â”€â”€ ContextMenuContent
        â”‚           â”œâ”€â”€ MenuGroup: ç¼–è¾‘æ“ä½œ
        â”‚           â”‚     â”œâ”€â”€ RenameMenuItem (Ctrl+R)
        â”‚           â”‚     â””â”€â”€ DeleteMenuItem (Delete)
        â”‚           â”œâ”€â”€ ContextMenuSeparator
        â”‚           â””â”€â”€ MenuGroup: å…¶ä»–æ“ä½œï¼ˆé¢„ç•™æ‰©å±•ï¼‰
        â””â”€â”€ LabelInputDialog (é‡å‘½åè¾“å…¥æ¡†ï¼Œå¤ç”¨ç°æœ‰)
```

### æ–‡ä»¶ç»„ç»‡

```
src/components/workbench/
  â”œâ”€â”€ BoundingBoxEditor.tsx (ä¿®æ”¹)
  â”œâ”€â”€ IconContextMenu.tsx (æ–°å¢)
  â””â”€â”€ menuConfig.ts (æ–°å¢ - èœå•é…ç½®)
```

---

## æ•°æ®ç»“æ„

### èœå•é¡¹é…ç½®

```typescript
interface MenuItemConfig {
  // åŸºæœ¬å±æ€§
  id: string;                    // å”¯ä¸€æ ‡è¯†
  label: string;                 // æ˜¾ç¤ºæ–‡æœ¬
  icon: LucideIcon;              // å›¾æ ‡ç»„ä»¶
  action: MenuAction;            // æ“ä½œç±»å‹

  // å¯é€‰å±æ€§
  shortcut?: string;             // å¿«æ·é”®æç¤º
  disabled?: boolean;            // æ˜¯å¦ç¦ç”¨
  separator?: boolean;           // åé¢æ˜¯å¦æ˜¾ç¤ºåˆ†éš”ç¬¦
  group?: string;                // åˆ†ç»„æ ‡è¯†
}

type MenuAction =
  | { type: 'rename' }
  | { type: 'delete' }
  | { type: 'custom'; handler: () => void };
```

### èœå•é…ç½®ç¤ºä¾‹

```typescript
import { Edit, Trash2 } from 'lucide-react';

export const CONTEXT_MENU_ITEMS: MenuItemConfig[] = [
  {
    id: 'rename',
    label: 'é‡å‘½å',
    icon: Edit,
    action: { type: 'rename' },
    shortcut: 'F2 / âŒ˜R',
    group: 'edit',
  },
  {
    id: 'separator-1',
    label: '',
    icon: null,
    action: { type: 'custom', handler: () => {} },
    separator: true,
  },
  {
    id: 'delete',
    label: 'åˆ é™¤',
    icon: Trash2,
    action: { type: 'delete' },
    shortcut: 'Del',
    group: 'actions',
  },
];
```

**å¿«æ·é”®æ˜¾ç¤ºè¯´æ˜**ï¼š
- `F2 / âŒ˜R`ï¼šF2 å’Œ Ctrl+Rï¼ˆMac æ˜¾ç¤ºä¸º âŒ˜Rï¼‰
- `Del`ï¼šDelete é”®çš„ç®€å†™

### ç»„ä»¶çŠ¶æ€

```typescript
interface ContextMenuState {
  isOpen: boolean;               // èœå•æ˜¯å¦æ‰“å¼€
  position: { x: number; y: number } | null;  // èœå•ä½ç½®
  targetBoxId: string | null;    // ç›®æ ‡è¾¹ç•Œæ¡† ID
}
```

---

## å®ç°ç»†èŠ‚

### 1. BoundingBoxEditor ä¿®æ”¹

#### ç§»é™¤ç›´æ¥æ ‡ç­¾ç¼–è¾‘

**ä¹‹å‰**ï¼š
```tsx
<div onClick={() => startEditingLabel(box.id)}>
  {iconLabels.get(box.id) || box.id}
</div>
```

**ä¹‹å**ï¼š
```tsx
<div>
  {iconLabels.get(box.id) || box.id}
  {/* ç§»é™¤ onClickï¼Œä¸å†æ”¯æŒç›´æ¥ç‚¹å‡»ç¼–è¾‘ */}
</div>
```

#### æ·»åŠ å³é”®èœå•è§¦å‘

```tsx
import { ContextMenuTrigger } from '@/components/ui/context-menu';

// åœ¨è¾¹ç•Œæ¡†ä¸Šæ·»åŠ  ContextMenuTrigger
<motion.div
  key={box.id}
  className={cn(
    'absolute border-2 transition-colors duration-150 group',
    // ... å…¶ä»–ç±»å
  )}
>
  <ContextMenuTrigger>
    {/* è¾¹ç•Œæ¡†å†…å®¹ */}
  </ContextMenuTrigger>

  {/* åµŒå…¥ ContextMenu */}
  <IconContextMenu
    boxId={box.id}
    onRename={() => {
      onSaveHistory();
      startEditingLabel(box.id);
    }}
    onDelete={() => {
      onSaveHistory();
      onBoxDelete(box.id);
    }}
  />
</motion.div>
```

#### å¤„ç†ç¼–è¾‘çŠ¶æ€å†²çª

```tsx
// ä¿®æ”¹ç°æœ‰çš„å³é”®èœå•ç¦ç”¨é€»è¾‘
const handleContextMenu = useCallback((e: React.MouseEvent) => {
  // å¦‚æœæ­£åœ¨ç¼–è¾‘æ ‡ç­¾ï¼Œé˜»æ­¢å³é”®èœå•
  if (editingLabel) {
    e.preventDefault();
    return;
  }

  // ... åŸæœ‰é€»è¾‘
}, [editingLabel]);
```

### 2. IconContextMenu ç»„ä»¶

```tsx
import {
  ContextMenu,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuSeparator,
  ContextMenuTrigger,
} from '@/components/ui/context-menu';
import { Edit, Trash2 } from 'lucide-react';
import { CONTEXT_MENU_ITEMS } from './menuConfig';

interface IconContextMenuProps {
  boxId: string;
  onRename: () => void;
  onDelete: () => void;
}

export function IconContextMenu({
  boxId,
  onRename,
  onDelete,
}: IconContextMenuProps) {
  const handleAction = useCallback(
    (actionType: string) => {
      switch (actionType) {
        case 'rename':
          onRename();
          break;
        case 'delete':
          onDelete();
          break;
      }
    },
    [onRename, onDelete]
  );

  return (
    <ContextMenu>
      <ContextMenuContent className="w-48">
        {CONTEXT_MENU_ITEMS.map((item, index) => {
          if (item.separator) {
            return <ContextMenuSeparator key={index} />;
          }

          const Icon = item.icon;

          return (
            <ContextMenuItem
              key={item.id}
              onClick={() => handleAction(item.action.type)}
            >
              <Icon className="w-4 h-4 mr-2" />
              <span>{item.label}</span>
              {item.shortcut && (
                <span className="ml-auto text-xs text-muted-foreground">
                  {item.shortcut}
                </span>
              )}
            </ContextMenuItem>
          );
        })}
      </ContextMenuContent>
    </ContextMenu>
  );
}
```

**å…³é”®ç‚¹**ï¼š
- `ContextMenu` è‡ªåŠ¨å¤„ç†å³é”®èœå•çš„è§¦å‘å’Œå®šä½
- `ContextMenuTrigger` åŒ…è£¹è¾¹ç•Œæ¡†å†…å®¹
- ä¸éœ€è¦æ‰‹åŠ¨ `preventDefault`ï¼ŒContextMenu å†…ç½®å¤„ç†

### 3. èœå•æ“ä½œå¤„ç†

```tsx
// åœ¨ BoundingBoxEditor æˆ– CanvasArea ä¸­
const handleMenuAction = useCallback(
  (action: MenuAction, boxId: string) => {
    switch (action.type) {
      case 'rename':
        // ä¿å­˜å†å²ï¼ˆç”¨äºæ’¤é”€ï¼‰
        onSaveHistory();
        // æ‰“å¼€é‡å‘½åè¾“å…¥æ¡†ï¼ˆä¼šè‡ªåŠ¨èšç„¦ï¼‰
        startEditingLabel(boxId);
        break;

      case 'delete':
        // ä¿å­˜å†å²ï¼ˆç”¨äºæ’¤é”€ï¼‰
        onSaveHistory();
        // åˆ é™¤è¾¹ç•Œæ¡†
        onBoxDelete(boxId);
        break;

      case 'custom':
        // æ‰§è¡Œè‡ªå®šä¹‰æ“ä½œ
        action.handler();
        break;
    }
  },
  [onSaveHistory, startEditingLabel, onBoxDelete]
);
```

### 4. å…¨å±€é”®ç›˜å¿«æ·é”®

```tsx
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // åªåœ¨æœ‰é€‰ä¸­å›¾æ ‡æ—¶å“åº”
    if (!selectedBox) return;

    // è¾“å…¥æ¡†æ‰“å¼€æ—¶ï¼Œç¦ç”¨å…¨å±€å¿«æ·é”®
    if (editingLabel) return;

    // é‡å‘½åå¿«æ·é”®
    if (e.key === 'F2' || (e.key === 'r' && (e.ctrlKey || e.metaKey))) {
      e.preventDefault();
      handleMenuAction({ type: 'rename' }, selectedBox);
    }

    // åˆ é™¤å¿«æ·é”®
    if (e.key === 'Delete') {
      e.preventDefault();
      handleMenuAction({ type: 'delete' }, selectedBox);
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [selectedBox, editingLabel, handleMenuAction]);
```

### 5. è¾¹ç•Œæ™ºèƒ½æ£€æµ‹

**è¯´æ˜**ï¼šä½¿ç”¨ `ContextMenu` ç»„ä»¶æ—¶ï¼ŒRadix UI ä¼šè‡ªåŠ¨å¤„ç†è¾¹ç•Œæ£€æµ‹å’Œæ™ºèƒ½å®šä½ï¼Œæ— éœ€æ‰‹åŠ¨å®ç°ã€‚èœå•ä¼šè‡ªåŠ¨ï¼š

- é¿å…è¶…å‡ºå±å¹•å³ä¾§
- é¿å…è¶…å‡ºå±å¹•åº•éƒ¨
- åœ¨ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨è°ƒæ•´æ–¹å‘

---

## å…³é”®å®ç°è¦ç‚¹

### 1. ç¼–è¾‘çŠ¶æ€å†²çªå¤„ç†

å½“ç”¨æˆ·æ­£åœ¨ç¼–è¾‘æ ‡ç­¾æ—¶ï¼ˆè¾“å…¥æ¡†æ‰“å¼€ï¼‰ï¼Œéœ€è¦é˜»æ­¢å³é”®èœå•ï¼š

```tsx
const handleContextMenu = useCallback((e: React.MouseEvent) => {
  // å¦‚æœæ­£åœ¨ç¼–è¾‘æ ‡ç­¾ï¼Œé˜»æ­¢å³é”®èœå•
  if (editingLabel) {
    e.preventDefault();
    e.stopPropagation();
    return;
  }
}, [editingLabel]);
```

### 2. è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦

é€‰æ‹©"é‡å‘½å"åï¼Œè¾“å…¥æ¡†åº”è¯¥è‡ªåŠ¨è·å¾—ç„¦ç‚¹ï¼š

```tsx
const startEditingLabel = useCallback((boxId: string) => {
  const currentLabel = iconLabels.get(boxId) || '';
  setEditingLabel(boxId);
  setLabelInput(currentLabel);
  setLabelError('');

  // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†ï¼ˆé€šè¿‡ useEffect å®ç°ï¼‰
  requestAnimationFrame(() => {
    const input = document.querySelector(`[data-input-box-id="${boxId}"]`) as HTMLInputElement;
    input?.focus();
    input?.select();
  });
}, [iconLabels]);
```

### 3. å…¨å±€å¿«æ·é”®ç¦ç”¨

è¾“å…¥æ¡†æ‰“å¼€æ—¶ï¼Œç¦ç”¨ Deleteã€F2ã€Ctrl+R å¿«æ·é”®ï¼š

```tsx
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // åªåœ¨æœ‰é€‰ä¸­å›¾æ ‡æ—¶å“åº”
    if (!selectedBox) return;

    // è¾“å…¥æ¡†æ‰“å¼€æ—¶ï¼Œç¦ç”¨å…¨å±€å¿«æ·é”®
    if (editingLabel) return;

    // ... å¿«æ·é”®å¤„ç†
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [selectedBox, editingLabel, handleMenuAction]);
```

### 4. ç©ºæ ‡ç­¾å¤„ç†

å½“ç”¨æˆ·æ¸…ç©ºæ ‡ç­¾æ–‡æœ¬æ—¶ï¼Œåˆ é™¤æ ‡ç­¾ï¼š

```tsx
const saveLabel = useCallback((boxId: string) => {
  const error = validateLabel(labelInput, boxId);
  if (error) {
    setLabelError(error);
    return;
  }

  if (labelInput.trim()) {
    // ä¿å­˜æ ‡ç­¾
    setIconLabel(boxId, labelInput.trim());
  } else {
    // æ¸…ç©ºæ ‡ç­¾ â†’ åˆ é™¤æ ‡ç­¾
    removeIconLabel(boxId);
  }

  setEditingLabel(null);
}, [labelInput, validateLabel, setIconLabel, removeIconLabel]);
```

### 5. ç„¦ç‚¹ç®¡ç†

ç¡®ä¿èœå•å…³é—­åç„¦ç‚¹è¿”å›åˆ°è¾¹ç•Œæ¡†ï¼š

```tsx
// IconContextMenu ç»„ä»¶ä¸­
<ContextMenuItem
  onClick={() => {
    handleAction(item.action.type);
    // ContextMenu ä¼šè‡ªåŠ¨å¤„ç†ç„¦ç‚¹è¿”å›
  }}
>
```

### 6. å¿«æ·é”®å¹³å°é€‚é…

æ£€æµ‹ç”¨æˆ·å¹³å°å¹¶æ˜¾ç¤ºæ­£ç¡®çš„å¿«æ·é”®æç¤ºï¼š

```tsx
const getShortcutDisplay = (baseShortcut: string): string => {
  if (baseShortcut === 'F2 / âŒ˜R') {
    return navigator.platform.includes('Mac') ? 'F2 / âŒ˜R' : 'F2 / Ctrl+R';
  }
  return baseShortcut;
};
```

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°èœå•é¡¹

#### æ­¥éª¤ 1ï¼šæ›´æ–°é…ç½®

```typescript
// menuConfig.ts
export const CONTEXT_MENU_ITEMS: MenuItemConfig[] = [
  // ... ç°æœ‰é¡¹
  {
    id: 'preview',
    label: 'é¢„è§ˆ',
    icon: Eye,
    action: { type: 'custom', handler: () => showPreview() },
    shortcut: 'P',
    group: 'view',
  },
];
```

#### æ­¥éª¤ 2ï¼šæ·»åŠ æ“ä½œå¤„ç†

```tsx
// åœ¨ handleMenuAction ä¸­æ·»åŠ æ–°çš„ case
const handleMenuAction = useCallback(
  (action: MenuAction, boxId: string) => {
    switch (action.type) {
      // ... ç°æœ‰ case
      case 'custom':
        action.handler();
        break;
    }
  },
  [/* ä¾èµ–é¡¹ */]
);
```

### æ·»åŠ èœå•åˆ†ç»„

```typescript
interface MenuGroup {
  id: string;
  label?: string;  // å¯é€‰çš„åˆ†ç»„æ ‡é¢˜
  items: MenuItemConfig[];
}

export const CONTEXT_MENU_GROUPS: MenuGroup[] = [
  {
    id: 'edit',
    label: 'ç¼–è¾‘',
    items: [
      { id: 'rename', label: 'é‡å‘½å', icon: Edit, ... },
      { id: 'duplicate', label: 'å¤åˆ¶', icon: Copy, ... },
    ],
  },
  {
    id: 'actions',
    label: 'æ“ä½œ',
    items: [
      { id: 'delete', label: 'åˆ é™¤', icon: Trash2, ... },
    ],
  },
];
```

### æ¡ä»¶æ˜¾ç¤ºèœå•é¡¹

```typescript
// åŠ¨æ€è¿‡æ»¤èœå•é¡¹
const getAvailableMenuItems = (
  boxId: string,
  config: MenuItemConfig[]
): MenuItemConfig[] => {
  return config.filter((item) => {
    // ç¤ºä¾‹ï¼šå·²åˆ é™¤çš„å›¾æ ‡ä¸æ˜¾ç¤ºåˆ é™¤é€‰é¡¹
    if (item.id === 'delete' && isBoxDeleted(boxId)) {
      return false;
    }

    // ç¤ºä¾‹ï¼šåªæœ‰å·²çŸ¢é‡åŒ–çš„å›¾æ ‡æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
    if (item.id === 'export' && !isVectorized(boxId)) {
      return false;
    }

    return true;
  });
};
```

---

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

- [ ] å³é”®ç‚¹å‡»è¾¹ç•Œæ¡†èƒ½æ­£ç¡®æ‰“å¼€èœå•
- [ ] å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸä¸æ‰“å¼€èœå•
- [ ] èœå•ä½ç½®æ­£ç¡®ï¼ˆé¼ æ ‡æŒ‡é’ˆä½ç½®ï¼‰
- [ ] èœå•åœ¨å±å¹•è¾¹ç¼˜æ—¶æ­£ç¡®è°ƒæ•´ä½ç½®
- [ ] ç‚¹å‡»èœå•é¡¹æ‰§è¡Œå¯¹åº”æ“ä½œ
- [ ] ç‚¹å‡»èœå•å¤–éƒ¨å…³é—­èœå•
- [ ] æŒ‰ ESC å…³é—­èœå•
- [ ] å…¨å±€åªæ˜¾ç¤ºä¸€ä¸ªèœå•ï¼ˆæ‰“å¼€æ–°èœå•æ—¶å…³é—­æ—§èœå•ï¼‰

### äº¤äº’æµ‹è¯•

- [ ] å³é”®æœªé€‰ä¸­çš„å›¾æ ‡ â†’ è‡ªåŠ¨é€‰ä¸­å¹¶æ‰“å¼€èœå•
- [ ] å³é”®å·²é€‰ä¸­çš„å›¾æ ‡ â†’ ç›´æ¥æ‰“å¼€èœå•
- [ ] é‡å‘½åæ“ä½œé›†æˆåˆ°æ’¤é”€å†å²
- [ ] åˆ é™¤æ“ä½œé›†æˆåˆ°æ’¤é”€å†å²
- [ ] å¿«æ·é”®ï¼ˆF2ã€Deleteã€Enterï¼‰æ­£ç¡®å·¥ä½œ
- [ ] è¾“å…¥æ¡†æ˜¾ç¤ºåœ¨è¾¹ç•Œæ¡†ä¸Šæ–¹

### é”®ç›˜å¯¼èˆªæµ‹è¯•

- [ ] ä¸Šä¸‹ç®­å¤´åœ¨èœå•é¡¹é—´å¯¼èˆª
- [ ] Enter æ‰§è¡Œé€‰ä¸­é¡¹
- [ ] ESC å…³é—­èœå•
- [ ] èœå•æ‰“å¼€æ—¶æŒ‰å…¶ä»–é”®ä¸è§¦å‘å…¨å±€å¿«æ·é”®

### å¯è®¿é—®æ€§æµ‹è¯•

- [ ] å®Œæ•´çš„é”®ç›˜å¯¼èˆªæ”¯æŒ
- [ ] å±å¹•é˜…è¯»å™¨æ­£ç¡®è¯»å‡ºèœå•é¡¹
- [ ] ç„¦ç‚¹ç®¡ç†æ­£ç¡®
- [ ] ARIA æ ‡ç­¾æ­£ç¡®

### è¾¹ç•Œæƒ…å†µæµ‹è¯•

- [ ] å¤šæ¬¡å¿«é€Ÿå³é”®ä¸åŒå›¾æ ‡
- [ ] å³é”®æ—¶å›¾æ ‡æ­£åœ¨è¢«æ‹–æ‹½
- [ ] å³é”®æ—¶æ­£åœ¨ç¼–è¾‘æ ‡ç­¾
- [ ] åˆ é™¤æœ€åä¸€ä¸ªè¾¹ç•Œæ¡†
- [ ] æ‰€æœ‰å›¾æ ‡éƒ½è¢«åˆ é™¤åå³é”®

### æ€§èƒ½æµ‹è¯•

- [ ] èœå•æ‰“å¼€å“åº”æ—¶é—´ < 100ms
- [ ] èœå•å…³é—­åŠ¨ç”»æµç•…ï¼ˆ60fpsï¼‰
- [ ] å¤§é‡è¾¹ç•Œæ¡†æ—¶èœå•æ€§èƒ½ä¸å—å½±å“

---

## å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰

1. âœ… ä» shadcn/ui æ·»åŠ  `ContextMenu` ç»„ä»¶
   ```bash
   npx shadcn@latest add context-menu
   ```
2. âœ… åˆ›å»º `IconContextMenu.tsx` ç»„ä»¶
3. âœ… åˆ›å»º `menuConfig.ts` é…ç½®æ–‡ä»¶
4. âœ… ä¿®æ”¹ `BoundingBoxEditor.tsx`ï¼š
   - ç§»é™¤ç›´æ¥ç‚¹å‡»æ ‡ç­¾ç¼–è¾‘åŠŸèƒ½
   - æ·»åŠ  ContextMenuTrigger
   - åµŒå…¥ IconContextMenu ç»„ä»¶
   - å¤„ç†ç¼–è¾‘çŠ¶æ€å†²çªï¼ˆè¾“å…¥æ¡†æ‰“å¼€æ—¶é˜»æ­¢å³é”®èœå•ï¼‰
5. âœ… å®ç°é‡å‘½åå’Œåˆ é™¤æ“ä½œ
6. âœ… é›†æˆæ’¤é”€/é‡åšç³»ç»Ÿ
7. âœ… å®ç°å…¨å±€å¿«æ·é”®ï¼ˆF2ã€Ctrl+Rã€Deleteï¼‰

### Phase 2: å¢å¼ºåŠŸèƒ½ï¼ˆé‡è¦ï¼‰

1. â¬œ è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦å’Œå…¨é€‰æ–‡æœ¬
2. â¬œ å¿«æ·é”®å¹³å°é€‚é…ï¼ˆMac æ˜¾ç¤º âŒ˜ï¼ŒWindows/Linux æ˜¾ç¤º Ctrlï¼‰
3. â¬œ ç©ºæ ‡ç­¾å¤„ç†ï¼ˆæ¸…ç©ºæ—¶åˆ é™¤æ ‡ç­¾ï¼‰
4. â¬œ èœå•åŠ¨ç”»ä¼˜åŒ–ï¼ˆ150ms æ·¡å…¥æ·¡å‡ºï¼‰
5. â¬œ ç„¦ç‚¹ç®¡ç†ä¼˜åŒ–

### Phase 3: ä¼˜åŒ–åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

1. â¬œ æ·»åŠ æ›´å¤šèœå•é¡¹ï¼ˆå¤åˆ¶ã€é¢„è§ˆã€å¯¼å‡ºç­‰ï¼‰
2. â¬œ å®ç°èœå•åˆ†ç»„
3. â¬œ æ·»åŠ èœå•é¡¹ç¦ç”¨é€»è¾‘ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼‰
4. â¬œ ç§»åŠ¨ç«¯æ”¯æŒï¼ˆé•¿æŒ‰è§¦å‘å³é”®èœå•ï¼‰
5. â¬œ æ·»åŠ æ“ä½œç¡®è®¤æç¤ºï¼ˆToastï¼‰

---

## Review æ€»ç»“

### å…³é”®å†³ç­–ç‚¹

åŸºäºéœ€æ±‚è®¿è°ˆï¼Œç¡®å®šäº†ä»¥ä¸‹å…³é”®æŠ€æœ¯å†³ç­–ï¼š

1. **ç»„ä»¶é€‰æ‹©**ï¼šä½¿ç”¨ Radix UI çš„ `ContextMenu` ç»„ä»¶è€Œé `DropdownMenu`
   - æ›´ç¬¦åˆå³é”®èœå•çš„äº¤äº’æ¨¡å¼
   - å†…ç½®é˜²æ­¢é»˜è®¤å³é”®èœå•åŠŸèƒ½
   - è‡ªåŠ¨å¤„ç†å®šä½å’Œè¾¹ç•Œæ£€æµ‹

2. **å¿«æ·é”®ç­–ç•¥**ï¼š
   - `F2`ï¼šWindows/Linux ä¼ ç»Ÿé‡å‘½åå¿«æ·é”®
   - `Ctrl+R`ï¼šè·¨å¹³å°ä¸€è‡´çš„é‡å‘½åå¿«æ·é”®
   - `Delete`ï¼šåˆ é™¤å›¾æ ‡
   - è¾“å…¥æ¡†æ‰“å¼€æ—¶ç¦ç”¨æ‰€æœ‰å¿«æ·é”®

3. **ç¼–è¾‘çŠ¶æ€ç®¡ç†**ï¼š
   - å®Œå…¨ç§»é™¤ç›´æ¥ç‚¹å‡»æ ‡ç­¾ç¼–è¾‘åŠŸèƒ½
   - è¾“å…¥æ¡†æ‰“å¼€æ—¶é˜»æ­¢å³é”®èœå•
   - ç©ºæ ‡ç­¾æ–‡æœ¬ â†’ åˆ é™¤æ ‡ç­¾

4. **ç„¦ç‚¹ç®¡ç†**ï¼š
   - é€‰æ‹©"é‡å‘½å"åè¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
   - èœå•å…³é—­åç„¦ç‚¹è¿”å›åˆ°è¾¹ç•Œæ¡†
   - ContextMenu è‡ªåŠ¨å¤„ç†ç„¦ç‚¹è¿”å›

5. **åˆ é™¤æ“ä½œ**ï¼š
   - ç›´æ¥åˆ é™¤ï¼ˆæ— ç¡®è®¤å¯¹è¯æ¡†ï¼‰
   - ä¾èµ–æ’¤é”€åŠŸèƒ½ï¼ˆCtrl+Zï¼‰

### å®ç°å¤æ‚åº¦è¯„ä¼°

- **æŠ€æœ¯éš¾åº¦**ï¼šä¸­ç­‰ï¼ˆä½¿ç”¨ç°æˆç»„ä»¶é™ä½éš¾åº¦ï¼‰
- **å¼€å‘æ—¶é—´**ï¼š2-3 å¤©ï¼ˆPhase 1ï¼‰
- **æ½œåœ¨é£é™©**ï¼š
  - ContextMenu ç»„ä»¶å¯èƒ½éœ€è¦é¢å¤–å®‰è£…
  - è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦å¯èƒ½éœ€è¦ requestAnimationFrame
  - å¿«æ·é”®å†²çªå¤„ç†éœ€è¦ä»”ç»†æµ‹è¯•

### å»ºè®®ä¼˜å…ˆçº§

**ç«‹å³å®æ–½**ï¼ˆPhase 1ï¼‰ï¼š
- æ ¸å¿ƒå³é”®èœå•åŠŸèƒ½
- é‡å‘½åå’Œåˆ é™¤æ“ä½œ
- æ’¤é”€/é‡åšé›†æˆ
- å…¨å±€å¿«æ·é”®

**åç»­ä¼˜åŒ–**ï¼ˆPhase 2ï¼‰ï¼š
- è‡ªåŠ¨èšç„¦å’Œå¿«æ·é”®ä¼˜åŒ–
- å¹³å°é€‚é…
- ç”¨æˆ·ä½“éªŒç»†èŠ‚

**æœªæ¥æ‰©å±•**ï¼ˆPhase 3ï¼‰ï¼š
- æ›´å¤šèœå•é¡¹
- é«˜çº§äº¤äº’åŠŸèƒ½

---

## ç›¸å…³æ–‡ä»¶

- `src/components/ui/context-menu/` - ContextMenu ç»„ä»¶ï¼ˆéœ€è¦æ·»åŠ ï¼‰
- `src/components/workbench/BoundingBoxEditor.tsx` - ä¸»è¦ä¿®æ”¹
- `src/components/workbench/IconContextMenu.tsx` - æ–°å»º
- `src/components/workbench/menuConfig.ts` - æ–°å»º
- `docs/CONTEXT_MENU_SPEC.md` - æœ¬æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2026-01-13 (ç»è¿‡è¯¦ç»†Review)
**ç‰ˆæœ¬**: 2.0
**ä½œè€…**: Claude Code
